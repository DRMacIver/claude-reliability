// Stop Hook State Machine
// Shows all possible states and transitions from user message to agent stop
digraph StopHookStateMachine {
    rankdir=TB;
    compound=true;
    node [shape=box, style=rounded];

    // Start and End nodes
    UserMessage [label="User Message\nReceived", shape=ellipse, style=filled, fillcolor=lightblue];
    AllowStop [label="Allow Stop\n(exit_code=0)", shape=ellipse, style=filled, fillcolor=lightgreen];
    BlockStop [label="Block Stop\n(exit_code=2)", shape=ellipse, style=filled, fillcolor=lightyellow];

    // ========== Early Checks (Order matters) ==========

    // 1. Problem Mode Check
    CheckProblemMode [label="Check:\nproblem_mode_active?"];
    ProblemModeExit [label="Problem Mode Exit"];

    // 2. API Error Loop Check
    CheckAPIErrors [label="Check:\nconsecutive_api_errors >= 2?"];
    APIErrorLoop [label="API Error Loop\nDetected"];

    // 3. Commit/Push Question Fast Path (git repos only)
    CheckCommitPushQ [label="Check:\nlast_output ends with\ncommit/push question?"];
    AutoConfirmCommit [label="Auto-confirm:\n\"Yes, please commit\""];
    AutoConfirmPush [label="Auto-confirm:\n\"Yes, please push\""];
    AutoConfirmBoth [label="Auto-confirm:\n\"Yes, commit and push\""];

    // 4. Validation Check
    CheckNeedsValidation [label="Check:\nneeds_validation marker?"];
    RunValidation [label="Run quality_check_command"];
    ValidationFailed [label="Validation Failed\n(show output)"];
    ClearValidation [label="Clear validation marker"];

    // 5. Fast Path Check (clean git repo)
    CheckGitClean [label="Check git status:\nno uncommitted changes?\nnot ahead of remote?"];
    FastPathExit [label="Fast Path:\nClean state"];

    // 6. Bypass Phrase Checks
    CheckBypassPhrases [label="Check last_output for:\n- HUMAN_INPUT_REQUIRED\n- PROBLEM_NEEDS_USER"];

    // Problem phrase path
    ProblemPhraseDetected [label="Problem Phrase\nDetected"];
    EnterProblemMode [label="Enter Problem Mode\n(block all tools)"];

    // Complete phrase path
    CompletePhraseDetected [label="Complete Phrase\nDetected"];
    CheckReadyIssues [label="Check tasks:\nopen task count?"];
    ExitPhraseRejected [label="Exit Phrase Rejected\n(open tasks remain)"];
    BypassAllowed [label="Bypass Allowed"];

    // 7. Uncommitted Changes Check
    CheckUncommitted [label="Check git:\nuncommitted changes?"];

    // Uncommitted Changes Handler
    subgraph cluster_uncommitted {
        label="Handle Uncommitted Changes";
        style=dashed;

        MarkHadChanges [label="Mark:\nhad_uncommitted_changes"];
        AnalyzeDiff [label="Analyze diff:\n- suppressions\n- empty except\n- secrets\n- TODOs"];
        RunQualityOnChanges [label="Run quality checks\n(if enabled)"];
        ShowUncommittedBlock [label="Block: Uncommitted\nChanges Detected\n(show analysis)"];
    }

    // 8. Unpushed Commits Check
    CheckUnpushed [label="Check:\nrequire_push &&\nahead_of_remote?"];
    UnpushedBlock [label="Block: Unpushed\nCommits"];

    // 9. Interactive Question Check
    CheckQuestion [label="Check:\nlooks_like_question?\nuser_recently_active?"];

    subgraph cluster_question {
        label="Handle Interactive Question";
        style=dashed;

        CheckContinueQ [label="Fast path:\nis_continue_question?"];
        AutoAnswerContinue [label="Auto-answer:\n\"Yes, please continue\""];
        SubAgentDecision [label="Sub-agent:\ndecide_on_question"];
        DecisionAllowStop [label="Decision:\nAllowStop"];
        DecisionAnswer [label="Decision:\nAnswer(response)"];
        DecisionContinue [label="Decision:\nContinue"];
    }

    // 10. Quality Check
    QualityCheck [label="Run quality checks\n(if enabled)"];
    QualityFailed [label="Quality Gates Failed"];

    // 11. Simple Reflection Check (marker-based)
    CheckReflectMarker [label="Check:\nmust_reflect marker?"];
    ClearReflectMarker [label="Clear reflect marker\n(second stop attempt)"];
    CheckModifyingTools [label="Check transcript:\nmodifying tool use?\n(Write/Edit/Delete)"];
    SetReflectMarker [label="Set reflect marker\nPrompt for reflection"];

    // 12. Auto-Work Task Check
    CheckAutoWorkTasks [label="Check:\nauto_work_on_tasks &&\nuser idle > N min &&\nopen tasks exist?"];
    AutoWorkBlock [label="Block:\nWork on open tasks"];

    // ========== Transitions ==========

    // Start
    UserMessage -> CheckProblemMode;

    // 1. Problem Mode
    CheckProblemMode -> ProblemModeExit [label="yes"];
    CheckProblemMode -> CheckAPIErrors [label="no"];
    ProblemModeExit -> AllowStop;

    // 2. API Errors
    CheckAPIErrors -> APIErrorLoop [label="yes"];
    CheckAPIErrors -> CheckCommitPushQ [label="no"];
    APIErrorLoop -> AllowStop;

    // 3. Commit/Push Question (git repos only)
    CheckCommitPushQ -> AutoConfirmCommit [label="commit question"];
    CheckCommitPushQ -> AutoConfirmPush [label="push question"];
    CheckCommitPushQ -> AutoConfirmBoth [label="commit+push question"];
    CheckCommitPushQ -> CheckNeedsValidation [label="no match"];
    AutoConfirmCommit -> BlockStop [label="inject response"];
    AutoConfirmPush -> BlockStop [label="inject response"];
    AutoConfirmBoth -> BlockStop [label="inject response"];

    // 4. Validation
    CheckNeedsValidation -> RunValidation [label="yes + cmd exists"];
    CheckNeedsValidation -> CheckGitClean [label="no"];
    RunValidation -> ValidationFailed [label="exit != 0"];
    RunValidation -> ClearValidation [label="exit == 0"];
    ValidationFailed -> BlockStop;
    ClearValidation -> CheckGitClean;

    // 5. Fast Path
    CheckGitClean -> FastPathExit [label="clean"];
    CheckGitClean -> CheckBypassPhrases [label="dirty or not git"];
    FastPathExit -> AllowStop;

    // 6. Bypass Phrases
    CheckBypassPhrases -> ProblemPhraseDetected [label="PROBLEM_NEEDS_USER"];
    CheckBypassPhrases -> CompletePhraseDetected [label="HUMAN_INPUT_REQUIRED"];
    CheckBypassPhrases -> CheckUncommitted [label="no bypass"];

    ProblemPhraseDetected -> EnterProblemMode;
    EnterProblemMode -> BlockStop [label="tools blocked"];

    CompletePhraseDetected -> CheckReadyIssues [label="tasks available"];
    CompletePhraseDetected -> BypassAllowed [label="no tasks"];
    CheckReadyIssues -> ExitPhraseRejected [label="open > 0"];
    CheckReadyIssues -> BypassAllowed [label="open == 0"];
    ExitPhraseRejected -> BlockStop;
    BypassAllowed -> AllowStop;

    // 7. Uncommitted Changes
    CheckUncommitted -> MarkHadChanges [label="yes", lhead=cluster_uncommitted];
    CheckUncommitted -> CheckUnpushed [label="no"];

    MarkHadChanges -> AnalyzeDiff;
    AnalyzeDiff -> RunQualityOnChanges;
    RunQualityOnChanges -> ShowUncommittedBlock;
    ShowUncommittedBlock -> BlockStop;

    // 8. Unpushed Commits
    CheckUnpushed -> UnpushedBlock [label="yes"];
    CheckUnpushed -> CheckQuestion [label="no"];
    UnpushedBlock -> BlockStop;

    // 9. Interactive Question
    CheckQuestion -> CheckContinueQ [label="is question +\nuser active", lhead=cluster_question];
    CheckQuestion -> QualityCheck [label="not question"];

    CheckContinueQ -> AutoAnswerContinue [label="yes"];
    CheckContinueQ -> SubAgentDecision [label="no"];
    AutoAnswerContinue -> BlockStop [label="inject response"];
    SubAgentDecision -> DecisionAllowStop [label="AllowStop"];
    SubAgentDecision -> DecisionAnswer [label="Answer"];
    SubAgentDecision -> DecisionContinue [label="Continue"];
    DecisionAllowStop -> AllowStop;
    DecisionAnswer -> BlockStop [label="inject response"];
    DecisionContinue -> QualityCheck;

    // 10. Quality Check
    QualityCheck -> QualityFailed [label="failed"];
    QualityCheck -> CheckReflectMarker [label="passed or\nnot enabled"];
    QualityFailed -> BlockStop;

    // 11. Simple Reflection (marker-based)
    CheckReflectMarker -> ClearReflectMarker [label="marker exists\n(second stop)"];
    CheckReflectMarker -> CheckModifyingTools [label="no marker"];
    ClearReflectMarker -> CheckAutoWorkTasks [label="check auto-work"];
    CheckModifyingTools -> SetReflectMarker [label="has modifying\ntool use"];
    CheckModifyingTools -> CheckAutoWorkTasks [label="no modifying\ntool use"];
    SetReflectMarker -> BlockStop [label="prompt reflection"];

    // 12. Auto-Work Task Check
    CheckAutoWorkTasks -> AutoWorkBlock [label="enabled &&\nidle && tasks"];
    CheckAutoWorkTasks -> AllowStop [label="disabled or\nuser active or\nno tasks"];
    AutoWorkBlock -> BlockStop;

    // ========== Legend ==========
    subgraph cluster_legend {
        label="Legend";
        rank=sink;

        LegendStart [label="Start/End", shape=ellipse, style=filled, fillcolor=lightblue];
        LegendAllow [label="Allow Stop", shape=ellipse, style=filled, fillcolor=lightgreen];
        LegendBlock [label="Block Stop", shape=ellipse, style=filled, fillcolor=lightyellow];
        LegendCheck [label="Decision Point", shape=box, style=rounded];
        LegendAction [label="Action/State", shape=box, style=rounded];

        LegendStart -> LegendAllow [style=invis];
        LegendAllow -> LegendBlock [style=invis];
        LegendBlock -> LegendCheck [style=invis];
        LegendCheck -> LegendAction [style=invis];
    }

    // ========== Tool Use Annotations ==========
    // (Shown as labels on transitions where relevant bash commands are invoked)

    // The following transitions involve specific tool uses:
    // - CheckGitClean: Bash(git diff --stat, git diff --cached --stat, git ls-files, git rev-list)
    // - CheckUncommitted: Bash(git diff --stat, git diff --cached --stat, git ls-files, git rev-list)
    // - AnalyzeDiff: Bash(git diff --cached, git diff)
    // - RunQualityOnChanges: Bash(sh -c "quality_command")
    // - RunValidation: Bash(sh -c "quality_command")
    // - CheckReadyIssues: MCP task tools
    // - SubAgentDecision: Sub-agent API call (decide_on_question)
}
